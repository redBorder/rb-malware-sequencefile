package net.redborder.malware.sequencefile.util;

import org.apache.curator.framework.CuratorFramework;
import org.apache.curator.framework.CuratorFrameworkFactory;
import org.apache.curator.framework.recipes.barriers.DistributedBarrier;
import org.apache.curator.retry.ExponentialBackoffRetry;
import org.apache.hadoop.conf.Configuration;
import org.apache.hadoop.fs.FileSystem;
import org.apache.hadoop.fs.Path;
import org.apache.hadoop.hdfs.DistributedFileSystem;
import org.apache.log4j.Logger;
import org.w3c.dom.Document;
import org.w3c.dom.NamedNodeMap;
import org.w3c.dom.Node;
import org.w3c.dom.NodeList;
import org.xml.sax.SAXException;

import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.parsers.ParserConfigurationException;
import javax.xml.transform.Transformer;
import javax.xml.transform.TransformerException;
import javax.xml.transform.TransformerFactory;
import javax.xml.transform.dom.DOMSource;
import javax.xml.transform.stream.StreamResult;
import java.io.File;
import java.io.IOException;
import java.util.List;


/**
 * Created by Lito on 23/3/15.
 */


public class ConfigFileModifier {

    private static final String WORKFLOW_FILE_PATH = "/opt/rb/var/rb-sequence-oozie/workflow/workflow.xml";
    private static List<String> loaders;
    private static ConfigFile configfile;
    private static DistributedBarrier barrierConfigurator;
    private static CuratorFramework client;
    private static final Logger log = Logger.getLogger(ConfigFileModifier.class);


    public static void setConfiguration() {
        try {

            ConfigFile.init();
            configfile = ConfigFile.getInstance();
            loaders = configfile.getLoaders();
            client = CuratorFrameworkFactory.newClient(ConfigFile.getInstance().getZkConnect(), new ExponentialBackoffRetry(1000, 5));

            client.start();
            if (client.checkExists().forPath("/rb_malware/configurer") == null) {
                client.create().creatingParentsIfNeeded().forPath("/rb_malware/configurer");
            }
            barrierConfigurator = new DistributedBarrier(client, "/rb_malware/configurer/barrier");
            barrierConfigurator.setBarrier();

            log.info("Loaders to use: " + loaders);
            DocumentBuilderFactory docFactory = DocumentBuilderFactory.newInstance();
            DocumentBuilder docBuilder = docFactory.newDocumentBuilder();
            Document doc = docBuilder.parse(WORKFLOW_FILE_PATH);


            Node start = doc.getElementsByTagName("start").item(0);

            log.info("Start loader is: " + loaders.get(0));
            NamedNodeMap attr = start.getAttributes();
            Node nodeAttr = attr.getNamedItem("to");
            nodeAttr.setTextContent(loaders.get(0));


            if (loaders.size() > 1) {
                for (int i = 0; i < doc.getElementsByTagName("action").getLength(); i++) {
                    Node action = doc.getElementsByTagName("action").item(i);

                    int index = loaders.indexOf(action.getAttributes().getNamedItem("name").getNodeValue());

                    if ((index + 1) < loaders.size() && index != -1 && !action.getAttributes().getNamedItem("name").getNodeValue().equals("delete")) {

                        for (int k = 0; k < doc.getElementsByTagName("action").item(i).getChildNodes().getLength(); k++) {
                            if (action.getChildNodes().item(k).getNodeName().equals("ok")) {
                                action.getChildNodes().item(k).getAttributes().getNamedItem("to").setTextContent(loaders.get(index + 1));
                                log.info("Linking " + action.getAttributes().getNamedItem("name").getNodeValue() + " to " + loaders.get(index + 1));
                            }
                        }
                    }
                }
            }

            String toend = loaders.get(loaders.size() - 1);
            NodeList end = doc.getElementsByTagName("action");
            for (int j = 0; j < end.getLength(); j++) {
                if (end.item(j).getAttributes().getNamedItem("name").getNodeValue().equals(toend)) {
                    for (int k = 0; k < end.item(j).getChildNodes().getLength(); k++) {
                        if (end.item(j).getChildNodes().item(k).getNodeName().equals("ok")) {
                            end.item(j).getChildNodes().item(k).getAttributes().getNamedItem("to").setTextContent("delete");
                            log.info("End loader is: " + loaders.get(loaders.size() - 1));
                        }
                    }
                }
            }

            NodeList actions = doc.getElementsByTagName("action");

            for (int j = actions.getLength() - 1; j > -1; j--) {
                if (loaders.contains(actions.item(j).getAttributes().getNamedItem("name").getNodeValue())) {
                    log.info("Saving " + actions.item(j).getAttributes().getNamedItem("name").getNodeValue() + " to workflow.");
                } else if (!actions.item(j).getAttributes().getNamedItem("name").getNodeValue().equals("delete") && !actions.item(j).getAttributes().getNamedItem("name").getNodeValue().equals("delete2")) {
                    log.info("Removing " + actions.item(j).getAttributes().getNamedItem("name").getNodeValue() + " from workflow.");
                    actions.item(j).getParentNode().removeChild(doc.getElementsByTagName("action").item(j));
                }
            }


            TransformerFactory transformerFactory = TransformerFactory.newInstance();
            Transformer transformer = transformerFactory.newTransformer();
            DOMSource source = new DOMSource(doc);
            StreamResult result = new StreamResult(new File("/opt/rb/var/rb-sequence-oozie/workflow/workflow2hdfs.xml"));
            transformer.transform(source, result);
            log.info("");
            log.info("Updating HDFS files.");

            Configuration conf = new Configuration();
            conf.addResource(new Path("/opt/rb/var/hadoop/etc/hadoop/core-site.xml"));
            conf.addResource(new Path("/opt/rb/var/hadoop/etc/hadoop/hdfs-site.xml"));

            conf.set("fs.hdfs.impl", org.apache.hadoop.hdfs.DistributedFileSystem.class.getName());
            FileSystem fs = FileSystem.get(conf);

            fs.mkdirs(new Path("/user/oozie"));
            fs.delete(new Path("/user/oozie/workflow"), true);
            fs.delete(new Path("/user/oozie/cache.yml"), true);
            fs.delete(new Path("/user/oozie/aerospike.yml"), true);

            log.info("HDFS workflowDir removed.");

            fs.mkdirs(new Path("/user/oozie/workflow"));
            fs.mkdirs(new Path("/user/oozie/workflow/lib"));


            log.info("HDFS workflowDir created.");

            fs.copyFromLocalFile(false, true,
                    new Path("/opt/rb/var/rb-sequence-oozie/workflow/workflow2hdfs.xml"),
                    new Path("/user/oozie/workflow/workflow.xml"));

            log.info("HDFS workflow uploaded.");

            fs.copyFromLocalFile(false, true,
                    new Path("/opt/rb/var/rb-sequence-oozie/workflow/lib/yara_rules/"),
                    new Path("/user/oozie/workflow/lib/yara_rules"));

            log.info("HDFS yara-rules uploaded.");

            fs.copyFromLocalFile(false, true,
                    new Path("/opt/rb/var/rb-sequence-oozie/workflow/lib/scripts/"),
                    new Path("/user/oozie/workflow/lib/scripts"));

            log.info("HDFS scripts lib uploaded.");

            fs.copyFromLocalFile(false, true,
                    new Path("/opt/rb/var/rb-sequence-oozie/workflow/lib/rb-malware-pig.jar"),
                    new Path("/user/oozie/workflow/lib/rb-pig-malware.jar"));

            log.info("HDFS rb-pig-malware.jar uploaded.");

            fs.copyFromLocalFile(false, true,
                    new Path("/opt/rb/var/rb-sequence-oozie/workflow/scripts/"),
                    new Path("/user/oozie/workflow/scripts"));

            log.info("HDFS scripts uploaded.");

            fs.copyFromLocalFile(false, true,
                    new Path("/opt/rb/var/rb-sequence-oozie/conf/cache.yml"),
                    new Path("/user/oozie/cache.yml"));

            log.info("HDFS cache.yml uploaded.");

            fs.copyFromLocalFile(false, true,
                    new Path("/opt/rb/var/rb-sequence-oozie/conf/weights.yml"),
                    new Path("/user/oozie/weights.yml"));

            log.info("HDFS weights.yml uploaded.");

            fs.copyFromLocalFile(false, true,
                    new Path("/opt/rb/var/rb-sequence-oozie/conf/aerospike.yml"),
                    new Path("/user/oozie/aerospike.yml"));

            log.info("HDFS aerospike.yml uploaded.");

            fs.close();
            barrierConfigurator.removeBarrier();
            client.close();

            log.info("HDFS files done");

        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}

