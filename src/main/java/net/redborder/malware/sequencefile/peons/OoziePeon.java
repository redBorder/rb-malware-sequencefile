package net.redborder.malware.sequencefile.peons;

import net.redborder.malware.sequencefile.util.logger.RbLogger;
import org.apache.oozie.client.OozieClient;
import org.apache.oozie.client.WorkflowJob;

import java.util.Properties;
import java.util.logging.Level;
import java.util.logging.Logger;

/**
 * Created by Maria on 26/02/15.
 */
public class OoziePeon extends Thread {

    String input;
    String output;
    private Logger log = null;


    public OoziePeon(String in) {
        input=in;
        output="out-test";
    }

    public OoziePeon(String in,String out) {
        input=in;
        output=out;
    }

    public void run()
    {
        log = RbLogger.getLogger(OoziePeon.class.getName());
        log.log(Level.INFO, "OoziePeon: running");

        OozieClient cliente;
        Properties conf;

        // Getting a Oozie client
        cliente = new OozieClient("http://oozie.redborder.cluster:11000/oozie");

        // Setting configuration
        conf = cliente.createConfiguration();

        conf.setProperty("job_tracker","hadoop_namenode.redborder.cluster:8032");      //
        conf.setProperty("name_node","hdfs://hadoop_namenode.redborder.cluster:8021"); //
        conf.setProperty("queue_name","default");              //

        // Configure Oozie
        conf.setProperty(OozieClient.APP_PATH,"${name_node}/user/hadoop/pig/workflow.xml");
        conf.setProperty("oozie.use.system.libpath","true");

        // Librarys
        conf.setProperty("malware_lib_path","${name_node}/user/hadoop/share/lib");
        conf.setProperty("malware_library","${malware_lib_path}/binarypig-1.0-SNAPSHOT-jar-with-dependencies.jar");

        // Shared Options
        conf.setProperty("use_devshm","true");
        conf.setProperty("timeout_ms","180000");
        conf.setProperty("out_put_prefix_path","${name_node}/user/oozie/"+output);
        conf.setProperty("in_put_prefix_path", "${name_node}" + input);
        //conf.setProperty("oozie.libpath","hdfs://localhost:8020/user/hadoop/share/lib");

        // Running workflow
        try{
            // Setting a Job
            String jobld = cliente.run(conf);
            System.out.println("Workflow job, " + jobld + "submitted");

            // Print the status every 10 seconds
            while (cliente.getJobInfo(jobld).getStatus()== WorkflowJob.Status.RUNNING) {
                System.out.println("Workflow  running...");
                Thread.sleep(10*1000);
            }
            log.log(Level.INFO, "Workflow  completed");
            log.log(Level.INFO, "Job ID: " + cliente.getJobInfo(jobld));

        } catch (Exception r) {
            System.out.println("Errors " + r.getLocalizedMessage());
            r.printStackTrace();
        }

    }

}
